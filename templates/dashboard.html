<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Management System</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“¦ Inventory Management System</h1>
            <p>Comprehensive tracking for conversion kits, spare parts, and returns</p>
            <nav class="nav">
                <a href="/">Dashboard</a>
                <a href="/conversion_kits">Conversion Kits</a>
                <a href="/spare_parts">Spare Parts</a>
                <a href="/returns">Returns</a>
            </nav>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number">{{ total_imported }}</div>
                <div>Total Imported</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ total_installed }}</div>
                <div>Total Installed</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ total_available }}</div>
                <div>Total Available</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ total_items }}</div>
                <div>Total Items</div>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number">{{ conversion_kits_count }}</div>
                <div>Conversion Kits</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ spare_parts_count }}</div>
                <div>Spare Parts</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" style="color: {% if out_of_stock_count > 0 %}#dc3545{% else %}#28a745{% endif %}">{{ out_of_stock_count }}</div>
                <div>Out of Stock Items</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" style="color: {% if low_stock_count > 0 %}#ffc107{% else %}#28a745{% endif %}">{{ low_stock_count }}</div>
                <div>Low Stock Items</div>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number">{{ return_count }}</div>
                <div>Total Returns</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ pending_returns }}</div>
                <div>Pending Returns</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ allocation_count }}</div>
                <div>Total Allocations</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ stock_availability }}%</div>
                <div>Stock Availability</div>
            </div>
        </div>

        <div class="section">
            <div class="section-header dropdown-toggle" onclick="toggleDropdown('addItemDropdown')">
                <h2>âž• Add New Item</h2>
                <span class="dropdown-arrow">â–¼</span>
            </div>
            <div id="addItemDropdown" class="dropdown-content" style="display: none;">
                <div class="section-content">
                    <form method="POST" action="/add_item" class="form-container">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Serial Number</label>
                                <input type="text" name="serial" required>
                            </div>
                            <div class="form-group">
                                <label>Item Name</label>
                                <input type="text" name="item_name" required>
                            </div>
                            <div class="form-group">
                                <label>Item Type</label>
                                <select name="item_type" required>
                                    <option value="conversion_kit">Conversion Kit</option>
                                    <option value="spare_part">Spare Part</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Admin</label>
                                <input type="text" name="admin">
                            </div>
                            <div class="form-group">
                                <label>Units Imported</label>
                                <input type="number" name="units_imported" value="0">
                            </div>
                            <div class="form-group">
                                <label>Units Available</label>
                                <input type="number" name="units_available" value="0">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Item</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="section performance-optimized">
            <div class="section-header">
                <h2>ðŸ”§ Conversion Kits</h2>
            </div>
            <div class="section-content scrollable-content">
                <div class="table-wrapper scrollable-content">
                <table id="conversionKitsTable" class="virtual-scroll">
                    <thead>
                        <tr><th>Serial</th><th>Item Name</th><th>Imported</th><th>Installed</th><th>Available</th><th>Actions</th></tr>
                    </thead>
                    <tbody>
                        {% for kit in conversion_kits %}
                        <tr class="table-row">
                            <td><strong>{{ kit['serial'] }}</strong></td>
                            <td>{{ kit['item_name'] }}</td>
                            <td>{{ kit['units_imported'] }}</td>
                            <td>{{ kit['units_installed'] }}</td>
                            <td><span class="{% if kit['units_available'] > 0 %}text-success{% else %}text-danger{% endif %}">{{ kit['units_available'] }}</span></td>
                            <td class="actions">
                                <button class="btn btn-warning btn-sm" onclick="editItem({{ kit['id'] }}, '{{ kit['serial'] }}', '{{ kit['item_name'] }}', '{{ kit['item_type'] }}', '{{ kit['admin'] or '' }}', '{{ kit['created_at'] or '' }}', {{ kit['units_imported'] }}, {{ kit['units_installed'] }}, {{ kit['units_available'] }})">Edit</button>
                                <a href="/delete_item/{{ kit['id'] }}" class="btn btn-danger btn-sm" onclick="return confirm('Delete this item?')">Delete</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                </div>
            </div>
        </div>

        <div class="section performance-optimized">
            <div class="section-header">
                <h2>ðŸ”© Spare Parts Overview</h2>
            </div>
            <div class="section-content scrollable-content">
                <div class="table-wrapper scrollable-content">
                <table id="sparePartsTable" class="virtual-scroll">
                    <thead>
                        <tr><th>Item Name</th><th>Serial</th><th>Imported</th><th>Given Out</th><th>Available</th><th>Status</th></tr>
                    </thead>
                    <tbody>
                        {% for part in spare_parts %}
                        <tr class="table-row">
                            <td>{{ part['item_name'] }}</td>
                            <td>{{ part['serial'] or 'N/A' }}</td>
                            <td>{{ part['units_imported'] or 0 }}</td>
                            <td>{{ part['units_installed'] or 0 }}</td>
                            <td>{{ part['units_available'] or 0 }}</td>
                            <td>
                                {% set available = part['units_available'] or 0 %}
                                {% if available > 5 %}
                                    <span class="btn btn-success btn-sm">In Stock</span>
                                {% elif available > 0 %}
                                    <span class="btn btn-warning btn-sm">Low Stock</span>
                                {% else %}
                                    <span class="btn btn-danger btn-sm">Out of Stock</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                </div>
            </div>
        </div>

        <div class="section performance-optimized">
            <div class="section-header">
                <h2>ðŸ“‹ Recent Activity</h2>
            </div>
            <div class="section-content scrollable-content">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h3>Latest Returns</h3>
                        <div class="table-wrapper scrollable-content">
                        <table id="recentReturnsTable" class="virtual-scroll">
                            <thead><tr><th>Date</th><th>Item</th><th>Personnel</th><th>Status</th></tr></thead>
                            <tbody>
                                {% if returns %}
                                    {% for ret in returns %}
                                    <tr class="table-row">
                                        <td>{{ ret['date'] }}</td>
                                        <td><strong>{{ ret['item_serial'] }}</strong></td>
                                        <td>{{ ret['personnel'] }}</td>
                                        <td>
                                            {% set status = ret['status'] or 'pending' %}
                                            <span class="btn btn-sm {% if status == 'processed' %}btn-success{% elif status == 'pending' %}btn-warning{% else %}btn-danger{% endif %}">
                                                {{ status.title() }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr><td colspan="4" style="text-align: center; color: #6c757d;">No recent returns</td></tr>
                                {% endif %}
                            </tbody>
                        </table>
                        </div>
                    </div>
                    <div>
                        <h3>Latest Kit Allocations</h3>
                        <div class="table-wrapper scrollable-content">
                        <table id="recentAllocationsTable" class="virtual-scroll">
                            <thead><tr><th>Date</th><th>Kit</th><th>Rider</th><th>Station</th></tr></thead>
                            <tbody>
                                {% if kit_allocations %}
                                    {% for alloc in kit_allocations %}
                                    <tr class="table-row">
                                        <td>{{ alloc['date'] }}</td>
                                        <td><span class="btn btn-primary btn-sm">{{ alloc['new_item_serial'] }}</span></td>
                                        <td>{{ alloc['rider_name'] }}</td>
                                        <td>{{ alloc['station'] or 'N/A' }}</td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr><td colspan="4" style="text-align: center; color: #6c757d;">No recent allocations</td></tr>
                                {% endif %}
                            </tbody>
                        </table>
                        </div>
                    </div>
                </div>
                
                {% if spare_replacements %}
                <div style="margin-top: 20px;">
                    <h3>Latest Spare Part Replacements</h3>
                    <div class="table-wrapper scrollable-content">
                    <table class="virtual-scroll">
                        <thead><tr><th>Date</th><th>Old Part</th><th>New Part</th><th>Rider</th><th>Station</th></tr></thead>
                        <tbody>
                            {% for rep in spare_replacements %}
                            <tr class="table-row">
                                <td>{{ rep['date'] }}</td>
                                <td><span class="btn btn-danger btn-sm">{{ rep['old_item_serial'] }}</span></td>
                                <td><span class="btn btn-success btn-sm">{{ rep['new_item_serial'] }}</span></td>
                                <td>{{ rep['rider_name'] }}</td>
                                <td>{{ rep['station'] or 'N/A' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Edit Item</h2>
            <form method="POST" id="updateForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>Serial Number</label>
                        <input type="text" id="editSerial" name="serial" required>
                    </div>
                    <div class="form-group">
                        <label>Item Name</label>
                        <input type="text" id="editItemName" name="item_name" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Item Type</label>
                        <select id="editItemType" name="item_type" required>
                            <option value="conversion_kit">Conversion Kit</option>
                            <option value="spare_part">Spare Part</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Admin</label>
                        <input type="text" id="editAdmin" name="admin">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Units Imported</label>
                        <input type="number" id="editUnitsImported" name="units_imported">
                    </div>
                    <div class="form-group">
                        <label>Units Installed</label>
                        <input type="number" id="editUnitsInstalled" name="units_installed">
                    </div>
                    <div class="form-group">
                        <label>Units Available</label>
                        <input type="number" id="editUnitsAvailable" name="units_available">
                    </div>
                </div>
                <div class="form-row">
                    <button type="submit" class="btn btn-success">Update Item</button>
                    <button type="button" class="btn btn-danger" onclick="closeModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Return Status Update Modal -->
    <div id="returnStatusModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeReturnModal()">&times;</span>
            <h2>Update Return Status</h2>
            <form method="POST" id="returnStatusForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>Status</label>
                        <select id="returnStatus" name="status" required>
                            <option value="pending">Pending</option>
                            <option value="processed">Processed</option>
                            <option value="rejected">Rejected</option>
                            <option value="under_review">Under Review</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="returnNotes" name="notes" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;"></textarea>
                    </div>
                </div>
                <div class="form-row">
                    <button type="submit" class="btn btn-success">Update Status</button>
                    <button type="button" class="btn btn-danger" onclick="closeReturnModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>